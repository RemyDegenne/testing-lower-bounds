\chapter{Total variation distance}

\begin{definition}[TV distance]
  \label{def:TV}
  \lean{ProbabilityTheory.tv}
  \leanok
  \uses{def:fDiv}
  Let $\mu, \nu$ be two measures on $\mathcal X$. The total variation distance between $\mu$ and $\nu$ is
  \begin{align*}
  \TV(\mu, \nu) = D_f(\mu, \nu) \quad \text{with } f: x \mapsto \frac{1}{2}\vert x - 1 \vert \: .
  \end{align*}
\end{definition}

\begin{lemma}
  \label{lem:tv_nonneg}
  %\lean{}
  %\leanok
  \uses{def:TV}
  $\TV(\mu, \nu) \ge 0$.
\end{lemma}

\begin{proof}
\begin{align*}
\TV(\mu, \nu)
= \frac{1}{2}\nu\left[ \vert \frac{d\mu}{d\nu} - 1 \vert \right] + \frac{1}{2}\mu_{\perp \nu}(\mathcal X).
\end{align*}
Both terms are nonnegative.
\end{proof}

\begin{lemma}
  \label{lem:tv_le_add}
  %\lean{}
  %\leanok
  \uses{def:TV}
  $\TV(\mu, \nu) \le \frac{1}{2}\nu(\mathcal X) + \frac{1}{2}\mu(\mathcal X)$.
\end{lemma}

\begin{proof}
Apply Lemma TODO (fDiv\_le\_zero\_add\_top in the code, not in the blueprint yet).
\end{proof}


\begin{lemma}
  \label{lem:tv_le_one}
  %\lean{}
  %\leanok
  \uses{def:TV}
  For probability measures,
  $\TV(\mu, \nu) \le 1$.
\end{lemma}

\begin{proof}
\uses{lem:tv_le_add}
By Lemma~\ref{lem:tv_le_add}, $\TV(\mu, \nu) \le \frac{1}{2}\nu(\mathcal X) + \frac{1}{2}\mu(\mathcal X) = 1$~.
\end{proof}

\begin{lemma}
  \label{lem:tv_eq_integral_abs}
  %\lean{}
  %\leanok
  \uses{def:TV}
  let $\xi$ be a dominating measure of $\mu$ and $\nu$. Then
  $\TV(\mu, \nu) = \frac{1}{2}\int_x \left\vert \frac{d\mu}{d\xi}(x) - \frac{d\nu}{d\xi}(x) \right\vert \partial\xi$.
\end{lemma}

\begin{proof}%\leanok
\end{proof}

\begin{lemma}
  \label{lem:one_sub_tv_eq_integral_min}
  %\lean{}
  %\leanok
  \uses{def:TV}
  For probability measures $\mu, \nu$, and a dominating measure $\xi$,
  \begin{align*}
  1 - \TV(\mu, \nu)
  = \int_x \min\left\{ \frac{d\mu}{d\xi}(x), \frac{d\nu}{d\xi}(x)\right\}\partial \xi
  \: .
  \end{align*}
\end{lemma}

\begin{proof}%\leanok
\uses{lem:tv_eq_integral_abs}
The key identity is $\min\{x, y\} = \frac{1}{2}\left(x + y - \vert x - y \vert\right)$.
By Lemma~\ref{lem:tv_eq_integral_abs}, then that identity,
\begin{align*}
1 - \TV(\mu, \nu)
&= 1 - \frac{1}{2}\int_x \left\vert \frac{d\mu}{d\xi}(x) - \frac{d\nu}{d\xi}(x)\right\vert \partial \xi
\\
&= 1 - \frac{1}{2}\int_x \frac{d\mu}{d\xi}(x) + \frac{d\nu}{d\xi}(x) - 2\min\left\{ \frac{d\mu}{d\xi}(x), \frac{d\nu}{d\xi}(x)\right\} \partial \xi
\\
&= \int_x \min\left\{ \frac{d\mu}{d\xi}(x), \frac{d\nu}{d\xi}(x)\right\}\partial \xi
\: .
\end{align*}
\end{proof}

\begin{lemma}
  \label{lem:tv_eq_sup_aux}
  %\lean{}
  %\leanok
  \uses{def:TV}
  Let $\mathcal F = \{f : \mathcal X \to \mathbb{R} \mid \Vert f \Vert_\infty \le 1\}$.
  Then $\frac{1}{2} \sup_{f \in \mathcal F} \left( \mu[f] - \nu[f] \right) \le \TV(\mu, \nu)$.
\end{lemma}

\begin{proof}
\uses{lem:tv_eq_integral_abs}
Let $p,q$ be the respective densities of $\mu, \nu$ with respect to $\xi=\mu+\nu$.
For any $f \in \mathcal F$,
\begin{align*}
\mu[f] - \nu[f]
= \int_x f(x)(p(x) - q(x)) \partial\xi
&\le \int_x \Vert f(x) \Vert_\infty \vert p(x) - q(x) \vert \partial\xi
\\
&\le \int_x \vert p(x) - q(x) \vert \partial\xi
= 2 \TV(\mu, \nu)
\: .
\end{align*}
The last equality is Lemma~\ref{lem:tv_eq_integral_abs}.
\end{proof}

\begin{theorem}
  \label{thm:tv_eq_sup_sub_measure}
  %\lean{}
  %\leanok
  \uses{def:TV}
  Let $\mu, \nu$ be two measures on $\mathcal X$ with $\mu(\mathcal X) = \nu(\mathcal X)$.\\
  Then $TV(\mu, \nu) = \sup_{E \text{ measurable}} \left( \mu(E) - \nu(E) \right)$.
\end{theorem}

\begin{proof}
\uses{lem:tv_eq_sup_aux,lem:tv_eq_integral_abs}
By choosing $f = 2 \mathbb{I}_E - 1$ in Lemma~\ref{lem:tv_eq_sup_aux}, we get $\mu(E) - \nu(E) \le TV(\mu, \nu)$ for all $E$, which proves
$TV(\mu, \nu) \ge \sup_{E \text{ measurable}} \left( \mu(E) - \nu(E) \right)$.

For the other direction, let $E = \{x \mid p(x) > q(x)\}$ where $p,q$ be the respective densities of $\mu, \nu$ with respect to $\xi=\mu+\nu$, which is measurable since $p$ and $q$ are. By Lemma~\ref{lem:tv_eq_integral_abs},
\begin{align*}
2\TV(\mu, \nu)
= \int_x \vert p(x) - q(x) \vert \partial \xi
= \int_{x \in E} (p(x) - q(x)) \partial \xi + \int_{x \in E^c} (q(x) - p(x)) \partial \xi
\: .
\end{align*}
Also since $\mu(\mathcal X) = \nu(\mathcal X)$, $\int_x (p(x) - q(x)) \partial \xi = 0$, such that
\begin{align*}
\int_{x \in E} (p(x) - q(x)) \partial \xi
= - \int_{x \in E^c} (p(x) - q(x)) \partial \xi
= \int_{x \in E^c} (q(x) - p(x)) \partial \xi
\end{align*}
We get that $\TV(\mu, \nu) = \int_{x \in E} (p(x) - q(x)) \partial \xi = \mu(E) - \nu(E)$ and we have equality.
\end{proof}

\begin{theorem}
  \label{thm:tv_eq_sup_sub_integral}
  %\lean{}
  %\leanok
  \uses{def:TV}
  Let $\mathcal F = \{f : \mathcal X \to \mathbb{R} \mid \Vert f \Vert_\infty \le 1\}$.
  Then $\TV(\mu, \nu) = \frac{1}{2} \sup_{f \in \mathcal F} \left( \mu[f] - \nu[f] \right)$.
\end{theorem}

\begin{proof}
\uses{lem:tv_eq_sup_aux,thm:tv_eq_sup_sub_measure}
Lemma~\ref{lem:tv_eq_sup_aux} gives $\TV(\mu, \nu) \ge \frac{1}{2} \sup_{f \in \mathcal F} \left( \mu[f] - \nu[f] \right)$.

TODO: extract equality case from the proof of Theorem~\ref{thm:tv_eq_sup_sub_measure}.
\end{proof}
