\section{Sequential testing}

In this section $(X_n)_{n \in \mathbb{N}}$ are i.i.d. random variables in a measurable space $\Omega$ with associated natural filtration $\mathcal F$.
$\tau$ is a stopping time with respect to $\mathcal F$.

For a product measure $\mu^{\otimes \mathbb{N}}$ on $\Omega^{\mathbb{N}}$, $\mu_\tau$ denotes the restriction of the measure to $\mathcal F_\tau$, the sigma-algebra generated by the stopping time $\tau$.

\begin{lemma}
  \label{lem:llr_stopping_time}
  %\lean{}
  %\leanok
  %\uses{}
  For $\mu, \nu$ two probability measures on $\Omega$, $\nu_\tau$ almost surely,
  $\log \frac{d \mu_\tau}{d \nu_\tau} = \sum_{n=1}^\tau \log \frac{d \mu}{d \nu}$.
\end{lemma}

\begin{proof}
\end{proof}

\begin{theorem}
  \label{thm:kl_stopping_time}
  %\lean{}
  %\leanok
  \uses{def:KL}
  For $\mu, \nu$ two probability measures on $\Omega$, $\KL(\mu_\tau, \mu_\tau) = \mu[\tau] \KL(\mu, \nu)$.
\end{theorem}

\begin{proof}
\uses{lem:llr_stopping_time}
TODO: need Wald's first identity.
\end{proof}

\begin{lemma}
  \label{lem:renyiMeasure_stopping_time}
  %\lean{}
  %\leanok
  \uses{def:renyiMeasure}
  For $\mu, \nu$ two probability measures on $\Omega$ and $\alpha \in (0,1)$, $(\mu^{(\alpha, \nu)})_\tau = (\mu_\tau)^{(\alpha, \nu_\tau)}$.
\end{lemma}

\begin{proof}
This is a guess, I did not check it. TODO
\end{proof}

\begin{theorem}
  \label{thm:renyi_stopping_time}
  %\lean{}
  %\leanok
  \uses{def:KL, def:Renyi, def:renyiMeasure}
  For $\mu, \nu$ two probability measures on $\Omega$ and $\alpha \in (0,1)$,
  $R_\alpha(\mu_\tau, \nu_\tau) = \mu^{\alpha, \nu}[\tau] R_\alpha(\mu, \nu)$.
\end{theorem}

\begin{proof}
\uses{thm:kl_stopping_time, cor:renyi_eq_add_kl, lem:renyiMeasure_stopping_time}
From Corollary~\ref{cor:renyi_eq_add_kl}, $(1 - \alpha) R_\alpha(\mu, \nu) = \alpha \KL(\mu^{(\alpha, \nu)}, \mu) + (1 - \alpha)\KL(\mu^{(\alpha, \nu)}, \nu)$, hence we can use Theorem~\ref{thm:kl_stopping_time} to write
\begin{align*}
\mu^{\alpha, \nu}[\tau] R_\alpha(\mu, \nu)
&= \frac{1}{1 - \alpha}\left(\alpha \mu^{\alpha, \nu}[\tau]\KL(\mu^{(\alpha, \nu)}, \mu) + (1 - \alpha)\mu^{\alpha, \nu}[\tau]\KL(\mu^{(\alpha, \nu)}, \nu) \right)
\\
&= \frac{1}{1 - \alpha}\left(\alpha \KL((\mu^{(\alpha, \nu)})_\tau, \mu_\tau) + (1 - \alpha)\KL((\mu^{(\alpha, \nu)})_\tau, \nu_\tau) \right)
\end{align*}
It then suffices to remark that $(\mu^{(\alpha, \nu)})_\tau = (\mu_\tau)^{(\alpha, \nu_\tau)}$, thanks to Lemma~\ref{lem:renyiMeasure_stopping_time}.

TODO: if that lemma does not hold, we still have the inequality $R_\alpha(\mu_\tau, \nu_\tau) \le \mu^{\alpha, \nu}[\tau] R_\alpha(\mu, \nu)$ by Lemma~\ref{lem:renyi_eq_inf_add_kl}.
\end{proof}